"use strict"
!function(t){"function"==typeof define&&define.amd?define(["jquery","nanoscroller"],t):t("object"==typeof exports?require("jquery","nanoscroller"):jQuery)}(function(t){function e(t){return String(t).length>1?t:"0"+t}function s(t){return[e(t.getDate()),e(t.getMonth()),e(t.getFullYear())].join(".")}function n(t){var e=new Date(1e3*t)
return(new Date).getDate()==e.getDate()?e.toLocaleTimeString():s(e)}function i(t,e){return t.length>e?t.substr(0,e-3)+"...":t}var r=function(e){this.attrs={id:0,text:"",date:0,clientDate:0,chatId:0,my:!1},this.render=function(){var e=t(this.tpl)
e.find(".text").text(this.attrs.text),e.find(".date").text(n(this.attrs.date)),this.attrs.my&&e.addClass("my"),this.$list.append(e)
var s=this.$list.parent().nanoScroller()
return this._msgHover||s.nanoScroller({scroll:"bottom"}),this},this.set=function(t){for(var e in t)t.hasOwnProperty(e)&&"undefined"!=typeof this.attrs[e]&&(this.attrs[e]=t[e])
return this},e&&this.set(e)},a=function(t){this.id=t||0,this.messages={},this.messageBuffer={},this.push=function(t,e){t instanceof r||(t.chatId=this.id,t=new r(t)),this.messages[t.attrs.id]=t,e&&t.render()
for(var s=0;s<this._msgAddEvents.length;s++)this._msgAddEvents[s](t,this)
return this},this.add=function(t){for(var e=0;e<t.length;e++)this.push(new r(t[e]))
return this},this.accept=function(t,e){if(t.id&&t.clientDate){var s=this.messageBuffer[t.clientDate]
if(s)return s.attrs.id=t.id,s.attrs.date=t.date,s.attrs.my=!0,this.push(s,e),delete this.messageBuffer[t.clientDate],this}return!1},this.addBuffer=function(t){t.chatId=this.id
var e=new r(t)
return this.messageBuffer[e.attrs.clientDate]=e,e},this.render=function(){r.prototype.$list.empty()
for(var t in this.messages)this.messages.hasOwnProperty(t)&&this.messages[t].render()},this._msgAddEvents=[],this.onAddMessage=function(t){return this._msgAddEvents.push(t),this}},h={CHAT_NOT_FOUND:{method:"defaultError",text:"Чат не найден"},USER_IS_NOT_ONLINE:{method:"notOnline",text:"Пользователь не в сети"},USER_IS_NOT_SELLER:{method:"notPermission",text:"Вы не можете авторизоваться как продавец"},USER_NOT_FOUND:{method:"oldToken",text:"Сессия устарела, пожалуйста авторизуйтесь заново."},CHAT_ID_IS_REQUIRED:{method:"defaultError",text:"Chat id is required"},TEXT_IS_REQUIRED:{method:"defaultError",text:"Text is required"},DATE_IS_REQUIRED:{method:"defaultError",text:"Date is required"}},o={user_not_online:"Пользователь не в сети"},c=function(e){e=t.extend({lastMsgLength:35,template:"dist/chat.tpl",reconnectCount:10,reconnectTime:3e3,ERRORS:null,TEXT:null},e||{}),e.ERRORS&&(h=e.ERRORS),e.TEXT&&(o=e.TEXT),this.initialize=function(){return t.when(this.render(e.template).done(t.proxy(function(){var s=t(document.body)
s.find(".ah-chat").remove(),s.append(this.el),this.setToken(e.token||localStorage.getItem("chatToken")),this.token&&this.initSocket(e.url),this.delegateEvents()},this))),this},this.destroy=function(){this._dontreconnect=!0,clearInterval(this._reconnect),this.ws&&this.ws.close(1e3),this.ws=null,this.$el&&this.$el.remove(),this.reset()},this.render=function(e){var s=t.Deferred()
return this.get(e,t.proxy(function(e){if(e){this.$el=t(e),this.el=this.$el.get(0)
var n=this.$el.find("#messageTpl")
this.msgTpl=n.html(),r.prototype.tpl=this.msgTpl,r.prototype.$list=this.$el.find(".messages"),n.remove()
var i=this.$el.find("#chatTpl")
this.chatTpl=i.html(),i.remove(),this.$el.addClass(this.type),s.resolve()}},this)),s.promise()},this.get=function(t,e,s){var n=new XMLHttpRequest
return n.open("GET",t,!0),n.send(),n.onreadystatechange=function(){4==n.readyState&&(200!=n.status?s&&s(n.responseText,n):e&&e(n.responseText,n))},n},this.delegateEvents=function(){return this.bindEvent(".fixed-btn > a","click","openWindow").bindEvent(".close-window","click","closeWindow").bindEvent(".auth-btn","click","authorization").bindEvent(".send-btn","click","sendMessage").bindEvent(".msg-text","keypress","sendByEnter").bindEvent(".messages","mouseover","messagesHover").bindEvent(".messages","mouseleave","messagesOut").bindEvent(".panel > .error","click","closeError")},this.reset=function(){this.el=null,this.$el=null,this.ws=null,this.msgTpl="",this.token=null,this.chats={},this.type=e.id?"seller":"user",this.socketOpened=!1,this._reconnect=0},this.initSocket=function(t,e){if(e&&(this.ws&&this.ws.close(3008),delete this.ws),t&&!this.ws){this.ws=new WebSocket(t)
var s=this
return this.ws.onopen=function(t){s.evt("socketOpen",t)},this.ws.onclose=function(t){s.evt("socketClose",t)},this.ws.onmessage=function(t){s.evt("socketMessage",t)},this.ws.onerror=function(t){return s.evt("socketError",t)},this}return!1},this.callSocket=function(t,e){if(this.ws&&1==this.ws.readyState&&t){var s={command:t}
return e&&(s.data=e),this.ws.send(JSON.stringify(s)),this}return!1},this.addChat=function(s,n){var r=new a(s)
if(n&&n.chatter&&(r.chatter=n.chatter),this.chats[r.id]=r,"seller"==this.type){var h=this.$el.find(".chats .list"),o=t(this.chatTpl),c=this
r.onAddMessage(function(t){o.find("p").text(i(t.attrs.text,e.lastMsgLength)),c.$el.hasClass("open")||c.newChatMessage(r,o)}),o.find("a").text(r.chatter),o.click(function(){t(this).removeClass("new"),c.openChat(r.id)}),h.append(o)}n&&n.messages&&r.add(n.messages)},this.newChatMessage=function(t,e){e.addClass("new"),this.$el.find(".fixed-btn .chats-btn").addClass("new")},this.isCurrentChat=function(t){return this.currentChat?t.id==this.currentChat.id:!1},this.firstChat=function(){for(var t in this.chats)if(this.chats.hasOwnProperty(t))return this.chats[t]
return null},this.openChat=function(t){return this.$el.addClass(this.currentChat?"chat":"have-not-chat"),t?this.currentChat=this.chats[t]:this.currentChat=this.firstChat(),this.currentChat&&(this.currentChat.render(),this.currentChat.status===!1?this.$el.find(".msg-text").removeAttr("contenteditable").html(o.user_not_online+"..."):this.$el.find(".msg-text").attr("contenteditable",!0).html(""),this.$el.find(".sellerName").text(this.currentChat.chatter)),this},this.setToken=function(t){return"undefined"!=typeof t?(this.token=t,localStorage.setItem("chatToken",this.token),this):!1},this.bindEvent=function(t,e,s){var n=this
return this.$el.find(t).off(e).on(e,function(t){n.evt(s,t)}),this},this.triggerMethod=function(t,e){var s=Array.prototype.slice.call(e)
return this[t][s.shift()].apply(this,s)},this.event={openWindow:function(){this.currentChat&&this.$el.removeClass("have-not-chat"),this.$el.addClass("open"),"user"==this.type&&this.token&&this.socketOpened&&this.openChat(),this.$el.find(".chats-btn").removeClass("new")},closeWindow:function(){"seller"==this.type&&this.$el.hasClass("chat")||this.$el.removeClass("open"),this.$el.removeClass("chat")},authorization:function(){var t=this.$el.find(".auth input"),s=t.val()
t.parent().removeClass("error"),s?(this.name=s,this.initSocket(e.url)):t.parent().addClass("error")},sendMessage:function(){var t=this.$el.find(".msg-text")
if(!t.attr("contenteditable"))return!1
var e=t.text()
if(t.text(""),e){var s=this.currentChat.addBuffer({text:e,clientDate:parseInt(Date.now()/1e3),chatId:this.currentChat.id})
return this.req("message",s.attrs),this}return!1},sendByEnter:function(t){return t&&13==t.keyCode&&!t.shiftKey&&this.evt("sendMessage"),this},messagesHover:function(){r.prototype._msgHover=!0},messagesOut:function(){r.prototype._msgHover=!1},closeError:function(){this.$el.find(".panel > .error").fadeOut(200)},socketOpen:function(){this.socketOpened=!0,this.req("auth",this.token,this.name,e.sellerId,e.id)},socketMessage:function(t){if(t&&t.data){var e=JSON.parse(t.data)
if(e.error){var s=h[e.error]?h[e.error].text:""
this.err(h[e.error]?h[e.error].method:"defaultError",s,e)}else e.command&&this.response[e.command]&&this.res(e.command,e.data)}},socketClose:function(){this.evt("serverUnavailable")},socketError:function(t){return t.preventDefault(),console.warn("AHChat: You can not open a connection, the server is unavailable."),this.evt("serverUnavailable"),!0},serverUnavailable:function(){if(!this._reconnect&&!this._dontreconnect){var t=this,s=Number(e.reconnectCount)
this._reconnect=setInterval(function(){t.initSocket(e.url,!0),s--,0==s&&clearInterval(t._reconnect)},e.reconnectTime),this.$el.removeClass("chat"),this.$el.find(".auth").addClass("unavailable")}},serverAvailable:function(){clearInterval(this._reconnect),delete this._reconnect,this._dontreconnect=null,this.$el.find(".auth").removeClass("unavailable")},online:function(t){this.$el.addClass("chat"),this.$el.find(".auth").removeClass("notOnline"),this.isCurrentChat(t)&&this.$el.find(".msg-text").attr("contenteditable",!0).html("")}},this.evt=function(){return this.triggerMethod("event",arguments)},this.errors={defaultError:function(t){this.$el.find(".panel > .error").text(t).fadeIn(200)},notOnline:function(t){this.isCurrentChat(t)&&(this.$el.removeClass("chat"),this.openChat(t.id)),this.$el.find(".auth").addClass("notOnline")},notPermission:function(t){this.err("defaultError",t),this.$el.removeClass("chat")},oldToken:function(){this.evt("serverAvailable"),this._dontreconnect=!0,this.ws.close(3003),this.setToken(""),this.reset(),this.initialize()}},this.err=function(){return this.triggerMethod("errors",arguments)},this.request={auth:function(t,e,s,n){var i={}
t&&(i.token=t),e&&(i.name=e),s&&(i.sellerId=s),n&&(i.id=n),this.callSocket("auth",i)},message:function(t){return this.callSocket("message",t)}},this.req=function(){return this.triggerMethod("request",arguments)},this.response={auth:function(t){if(t.name&&(this.name=t.name),t.chats)for(var e in t.chats)t.chats.hasOwnProperty(e)&&this.addChat(e,t.chats[e])
t.token&&this.setToken(t.token),this.openChat(),this.evt("serverAvailable")},message:function(t){if(t.chatId){var e=this.chats[t.chatId],s=this.isCurrentChat(e)
t.clientDate?e.accept(t,s):e.push(t,s)}},chat:function(t){this.addChat(t.id,t)},status:function(t){if(t.chatId){var e=this.chats[t.chatId]
e.status=1==t.status,e.status?this.evt("online",e):this.err("notOnline",e)}}},this.res=function(){return this.triggerMethod("response",arguments)},this.reset()}
return window.AHChat=c,c})
